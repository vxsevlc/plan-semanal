<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planificador de Comidas ‚Äî Juan y Marian</title>

  <!-- Tailwind & Font Awesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    :root{
      /* Colores corporativos */
      --brand:#009688;        /* principal */
      --brand-dark:#00796b;   /* hover */
      --brand-100:#e0f2f1;    /* fondo chip */
    }

    html,body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .gradient-brand{background:linear-gradient(135deg,var(--brand) 0%,var(--brand-dark) 100%)}
    .tab-active{background:var(--brand);color:#fff}
    .tab-inactive{background:#fff;color:#6b7280}
    .hover-lift{transition:transform .25s ease, box-shadow .25s ease}
    .hover-lift:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .fade-in{animation:fadeIn .25s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

    /* --------- Calendario (una sola grid para alinear perfecto) --------- */
    .calendar-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
    .calendar-grid{
      display:grid;
      grid-template-columns:120px repeat(7, 180px);
      grid-auto-rows:auto;
      min-width:max-content;
    }
    @media (min-width:1024px){
      .calendar-grid{ grid-template-columns:140px repeat(7, 1fr); }
    }
    .slot{min-height:5.25rem}
    @media (min-width:768px){ .slot{min-height:6.25rem} }

    .cell{border-right:1px solid #e5e7eb}
    .row-divider{border-top:1px solid #e5e7eb}

    /* Cabeceras d√≠a */
    .day-head{padding:.75rem;text-align:center;background:#f9fafb}
    .day-head .name{font-weight:600;color:#374151}
    .day-head .date{font-size:.75rem;color:#6b7280}

    /* Pastilla legible y centrada (nombre en varias l√≠neas y tama√±o adaptativo) */
    .meal-chip{
      display:flex;align-items:center;gap:.5rem;
      padding:.45rem .6rem;border-radius:.8rem;
      background:var(--brand-100);border:1px solid #b2dfdb;
      max-width:100%; text-align:center;
    }
    .meal-name{
      white-space:normal;        /* permite saltos de l√≠nea */
      word-break:break-word;     /* evita ‚Äúcolumna de letras‚Äù */
      overflow-wrap:anywhere;
      line-height:1.15;
      font-size:clamp(.78rem, 2.6vw, .95rem); /* se adapta en m√≥vil */
    }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Header -->
  <header class="gradient-brand text-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between py-4">
        <div class="flex items-center gap-3">
          <div class="text-3xl">üçΩÔ∏è</div>
          <div>
            <h1 class="text-2xl font-bold">Planificador de Comidas</h1>
            <p class="text-sm opacity-90">Organiza tu semana culinaria con facilidad</p>
          </div>
        </div>
        <div class="hidden md:flex items-center gap-6 text-sm">
          <div class="text-center"><div class="text-2xl font-bold" id="kpi-total-recipes">0</div><div class="text-xs opacity-80">Recetas</div></div>
          <div class="text-center"><div class="text-2xl font-bold" id="kpi-lunch-recipes">0</div><div class="text-xs opacity-80">Comidas</div></div>
          <div class="text-center"><div class="text-2xl font-bold" id="kpi-dinner-recipes">0</div><div class="text-xs opacity-80">Cenas</div></div>
        </div>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="flex gap-3 py-2" aria-label="Tabs">
        <button id="tab-calendar" class="tab-button tab-active px-4 md:px-6 py-3 text-sm font-medium rounded-lg"><i class="fa-regular fa-calendar mr-2"></i>Calendario</button>
        <button id="tab-recipes"  class="tab-button tab-inactive px-4 md:px-6 py-3 text-sm font-medium rounded-lg"><i class="fa-solid fa-utensils mr-2"></i>Base de Datos</button>
        <button id="tab-shopping" class="tab-button tab-inactive px-4 md:px-6 py-3 text-sm font-medium rounded-lg"><i class="fa-solid fa-list-check mr-2"></i>Lista de Compras</button>
      </nav>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- CALENDARIO -->
    <section id="calendar-view" class="tab-content">
      <div class="flex items-center justify-between gap-3 mb-4">
        <div>
          <h2 class="text-2xl font-bold text-gray-900">Planificaci√≥n semanal</h2>
          <p class="text-gray-600" id="week-range">‚Äî</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="prev-week" class="p-2 rounded-lg bg-white shadow hover:shadow-md"><i class="fa-solid fa-chevron-left text-gray-600"></i></button>
          <div id="week-chip" class="bg-emerald-100 text-emerald-800 px-3 py-2 rounded-lg font-medium">Semana</div>
          <button id="next-week" class="p-2 rounded-lg bg-white shadow hover:shadow-md"><i class="fa-solid fa-chevron-right text-gray-600"></i></button>
          <button id="clear-plan" class="px-3 py-2 rounded-lg border border-red-200 text-red-600 hover:bg-red-50"><i class="fa-solid fa-trash mr-2"></i>Limpiar</button>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg">
        <div class="calendar-wrap">
          <div id="calendar-grid" class="calendar-grid">
            <!-- Se rellena por JS: 1¬™ fila = cabecera; 2¬™ = comida; 3¬™ = cena -->
          </div>
        </div>
      </div>

      <!-- Quick Add -->
      <div class="mt-6 bg-white rounded-xl shadow p-6">
        <div class="flex items-baseline justify-between">
          <h3 class="text-lg font-semibold">A√±adir r√°pido</h3>
          <p class="text-sm text-gray-500">Elige una receta y toca una casilla</p>
        </div>
        <div id="quick-recipes" class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3"></div>
      </div>
    </section>

    <!-- BASE DE DATOS -->
    <section id="recipes-view" class="tab-content hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold"><i class="fa-solid fa-database mr-3 text-emerald-500"></i>Base de datos de comidas</h2>
        <div class="flex gap-2">
          <button id="export-json" class="px-3 py-2 rounded-lg border hover:bg-gray-50"><i class="fa-solid fa-file-arrow-down mr-2"></i>Exportar</button>
          <label class="px-3 py-2 rounded-lg border hover:bg-gray-50 cursor-pointer"><i class="fa-solid fa-file-arrow-up mr-2"></i>Importar<input id="import-json" type="file" accept="application/json" class="hidden"/></label>
          <button id="add-recipe-btn" class="px-4 py-2 rounded-lg text-white" style="background:var(--brand)"><i class="fa-solid fa-plus mr-2"></i>A√±adir</button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-emerald-50 rounded-lg p-4 text-center"><div class="text-2xl font-bold text-emerald-800" id="recipes-count">0</div><div class="text-sm text-emerald-700">Comidas</div></div>
        <div class="bg-blue-50 rounded-lg p-4 text-center"><div class="text-2xl font-bold text-blue-800" id="dinners-count">0</div><div class="text-sm text-blue-700">Cenas</div></div>
        <div class="bg-purple-50 rounded-lg p-4 text-center"><div class="text-2xl font-bold text-purple-800" id="total-ingredients">0</div><div class="text-sm text-purple-700">Ingredientes √∫nicos</div></div>
      </div>

      <div class="bg-white rounded-xl shadow p-6 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
          <div class="flex-1 relative">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
            <input id="recipe-search" class="w-full pl-10 pr-4 py-3 border rounded-lg focus:ring-2 focus:ring-emerald-500" placeholder="Buscar por nombre, descripci√≥n o ingredientes..."/>
          </div>
          <div class="flex gap-2">
            <select id="difficulty-filter" class="px-4 py-3 border rounded-lg focus:ring-2 focus:ring-emerald-500">
              <option value="">Todas</option><option value="facil">F√°cil</option><option value="media">Media</option><option value="dificil">Dif√≠cil</option>
            </select>
            <select id="type-filter" class="px-4 py-3 border rounded-lg focus:ring-2 focus:ring-emerald-500">
              <option value="">Todos</option><option value="lunch">Comida</option><option value="dinner">Cena</option>
            </select>
          </div>
        </div>
      </div>

      <div id="recipes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- LISTA DE LA COMPRA -->
    <section id="shopping-view" class="tab-content hidden">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold"><i class="fa-solid fa-cart-shopping mr-3 text-blue-500"></i>Lista de compras</h2>
          <p class="text-gray-600">Ingredientes necesarios para tu planificaci√≥n semanal</p>
        </div>
        <div class="flex gap-2">
          <button id="generate-list-btn" class="px-4 py-2 rounded-lg text-white" style="background:#2563eb"><i class="fa-solid fa-rotate mr-2"></i>Generar</button>
          <button id="clear-list-btn" class="px-3 py-2 rounded-lg border border-red-200 text-red-600 hover:bg-red-50"><i class="fa-solid fa-trash mr-2"></i>Limpiar</button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-lg font-semibold mb-4">Lista de ingredientes</h3>
          <div id="shopping-list" class="space-y-3">
            <div id="shopping-empty" class="text-center py-8 text-gray-500">
              <i class="fa-solid fa-list-ul text-4xl mb-2"></i>
              <p>No hay ingredientes en la lista</p>
              <p class="text-sm">Planifica algunas comidas y genera la lista</p>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-lg font-semibold mb-4">Ingredientes m√°s frecuentes</h3>
          <div id="top-ingredients" class="space-y-2"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- MODALES -->
  <div id="recipe-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden fade-in">
      <div class="p-4 border-b flex items-center gap-3">
        <h3 class="text-xl font-bold">Elegir receta</h3>
        <div class="ml-auto relative w-1/2">
          <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
          <input id="modal-search" class="w-full pl-10 pr-4 py-2 border rounded-lg" placeholder="Buscar..."/>
        </div>
        <button id="close-modal" class="ml-2 px-3 py-2 rounded-lg border hover:bg-gray-50"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="modal-list" class="p-4 overflow-y-auto max-h-[70vh] space-y-2"></div>
    </div>
  </div>

  <div id="add-recipe-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full fade-in">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold">A√±adir nueva receta</h3>
          <button id="close-add-modal" class="text-gray-500 hover:text-gray-700"><i class="fa-solid fa-times text-xl"></i></button>
        </div>
        <form id="add-recipe-form" class="space-y-4">
          <div><label class="block text-sm font-medium mb-1">Nombre</label><input id="recipe-name" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500" placeholder="Ej: Paella Valenciana"/></div>
          <div><label class="block text-sm font-medium mb-1">Descripci√≥n</label><textarea id="recipe-description" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500" rows="2" placeholder="Descripci√≥n breve"></textarea></div>
          <div class="grid grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium mb-1">Tipo</label><select id="recipe-type" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500"><option value="">Seleccionar</option><option value="lunch">Comida</option><option value="dinner">Cena</option></select></div>
            <div><label class="block text-sm font-medium mb-1">Dificultad</label><select id="recipe-difficulty" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500"><option value="">Seleccionar</option><option value="facil">F√°cil</option><option value="media">Media</option><option value="dificil">Dif√≠cil</option></select></div>
          </div>
          <div><label class="block text-sm font-medium mb-1">Tiempo (min)</label><input id="recipe-time" type="number" min="5" max="300" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500" placeholder="30"/></div>
          <div><label class="block text-sm font-medium mb-1">Ingredientes (uno por l√≠nea)</label><textarea id="recipe-ingredients" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500" rows="4" placeholder="arroz&#10;pollo&#10;pimiento rojo&#10;ajo"></textarea></div>
          <div class="flex gap-3 pt-2">
            <button class="flex-1 py-3 rounded-lg text-white" style="background:var(--brand)" type="submit"><i class="fa-solid fa-plus mr-2"></i>A√±adir</button>
            <button id="cancel-add" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg hover:bg-gray-200" type="button">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- (Opcional) Firebase para sincronizar en tiempo real (desactivado) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    /* =========================
       Utilidades + Datos base
       ========================= */
    const $  = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

    const toISO = d => new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())).toISOString().slice(0,10);
    const fromISO = iso => { const [y,m,dd] = iso.split('-').map(Number); return new Date(Date.UTC(y,m-1,dd)); };
    const startOfWeekMonday=(date=new Date())=>{
      const d=new Date(Date.UTC(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate()));
      const w=d.getUTCDay(); const diff=(w===0?-6:1)-w; d.setUTCDate(d.getUTCDate()+diff); return d;
    };
    const addDays=(date,n)=>{ const d=new Date(date); d.setUTCDate(d.getUTCDate()+n); return d; };
    const dayKeys=['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
    const dayNames=['Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado','Domingo'];

    /* LocalStorage */
    const LS_RECIPES='mp_recipes_v1';
    const planKey=weekISO=>`mp_plan_${weekISO}`;
    const storage={
      getRecipes(){ try{ return JSON.parse(localStorage.getItem(LS_RECIPES)) || null }catch{return null} },
      saveRecipes(list){ localStorage.setItem(LS_RECIPES, JSON.stringify(list)) },
      getPlan(weekISO){ const raw=localStorage.getItem(planKey(weekISO)); return raw? JSON.parse(raw):null; },
      savePlan(weekISO,plan){ localStorage.setItem(planKey(weekISO), JSON.stringify(plan)); },
      clearPlan(weekISO){ localStorage.removeItem(planKey(weekISO)); }
    };

    /* Semilla recetas */
    const seedRecipes=[
      {id:1,name:'Ensalada C√©sar con Pollo',description:'Ensalada fresca',difficulty:'facil',time:20,type:'lunch',ingredients:['lechuga romana','pollo','parmesano','pan tostado','ajo','lim√≥n','aceite de oliva']},
      {id:2,name:'Bowl de Quinoa y Verduras',description:'Bowl saludable',difficulty:'facil',time:25,type:'lunch',ingredients:['quinoa','br√≥coli','zanahoria','garbanzos','aguacate','lim√≥n']},
      {id:3,name:'Pasta al Pesto con Tomates',description:'Pasta italiana',difficulty:'media',time:30,type:'dinner',ingredients:['pasta','albahaca','pi√±ones','ajo','parmesano','tomates cherry','aceite de oliva']},
      {id:4,name:'Salm√≥n al Horno con Verduras',description:'Pescado al horno',difficulty:'media',time:35,type:'dinner',ingredients:['salm√≥n','calabac√≠n','pimiento','cebolla','lim√≥n']},
      {id:5,name:'Paella Valenciana',description:'Cl√°sico valenciano',difficulty:'dificil',time:75,type:'lunch',ingredients:['arroz','pollo','conejo','jud√≠a verde','garrof√≥n','tomate','azafr√°n','aceite de oliva']}
    ];

    let recipes = storage.getRecipes() || seedRecipes;
    let currentWeekStart = startOfWeekMonday(new Date());
    let selectedQuickRecipeId = null;

    function emptyPlan(){
      const slots={}; for(const d of dayKeys){ slots[`${d}-lunch`]=null; slots[`${d}-dinner`]=null; }
      return {weekStartISO:toISO(currentWeekStart), slots};
    }
    const getActivePlan=()=> storage.getPlan(toISO(currentWeekStart)) || emptyPlan();

    /* =========================
       Calendario (una sola grid)
       ========================= */
    function buildCalendarGrid(){
      const grid = $('#calendar-grid');
      grid.innerHTML = '';

      // 1) Fila cabecera
      const headFirst = document.createElement('div');
      headFirst.className = 'day-head cell';
      headFirst.innerHTML = '<div class="name">Tipo</div>';
      grid.appendChild(headFirst);

      for(let i=0;i<7;i++){
        const d = addDays(currentWeekStart,i);
        const cell = document.createElement('div');
        cell.className = 'day-head cell';
        cell.innerHTML = `<div class="name">${dayNames[i]}</div><div class="date">${d.getUTCDate()} ${d.toLocaleString('es-ES',{month:'short',timeZone:'UTC'})}</div>`;
        grid.appendChild(cell);
      }

      // 2) Fila comida
      const tipoComida = document.createElement('div');
      tipoComida.className = 'cell p-3 md:p-4 bg-emerald-50 flex items-center justify-center row-divider';
      tipoComida.innerHTML = `<div class="flex items-center gap-2 text-emerald-700"><i class="fa-solid fa-utensils"></i><span class="font-medium">Comida</span></div>`;
      grid.appendChild(tipoComida);

      const plan = getActivePlan();
      for(let i=0;i<7;i++){
        const dk = dayKeys[i];
        const slot = createSlot(dk,'lunch',plan.slots[`${dk}-lunch`]);
        slot.classList.add('cell','row-divider');
        grid.appendChild(slot);
      }

      // 3) Fila cena
      const tipoCena = document.createElement('div');
      tipoCena.className = 'cell p-3 md:p-4 bg-blue-50 flex items-center justify-center row-divider';
      tipoCena.innerHTML = `<div class="flex items-center gap-2 text-blue-700"><i class="fa-regular fa-moon"></i><span class="font-medium">Cena</span></div>`;
      grid.appendChild(tipoCena);

      for(let i=0;i<7;i++){
        const dk = dayKeys[i];
        const slot = createSlot(dk,'dinner',plan.slots[`${dk}-dinner`]);
        slot.classList.add('cell','row-divider');
        grid.appendChild(slot);
      }

      // texto cabecera semana
      const end=addDays(currentWeekStart,6);
      $('#week-range').textContent=`Semana del ${currentWeekStart.getUTCDate()} de ${currentWeekStart.toLocaleString('es-ES',{month:'long',timeZone:'UTC'})} al ${end.getUTCDate()} de ${end.toLocaleString('es-ES',{month:'long',timeZone:'UTC'})} ${end.getUTCFullYear()}`;
      $('#week-chip').textContent=`Semana ${getISOWeekNumber(fromISO(toISO(currentWeekStart)))}`;
    }

    function getISOWeekNumber(d){ const x=new Date(Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate())); x.setUTCDate(x.getUTCDate()+4-(x.getUTCDay()||7)); const y=new Date(Date.UTC(x.getUTCFullYear(),0,1)); return Math.ceil(((x-y)/86400000+1)/7); }

    function createSlot(dayKey,meal,recipeId){
      const el=document.createElement('div');
      el.className='meal-slot slot p-3 md:p-4 hover:bg-gray-50 cursor-pointer flex items-center justify-center';
      el.dataset.day=dayKey; el.dataset.meal=meal;
      el.addEventListener('click', onSlotClick);
      el.addEventListener('dragover', e=>e.preventDefault());
      el.addEventListener('drop', onSlotDrop);
      renderSlotContent(el, recipeId);
      return el;
    }
    function renderSlotContent(slotEl, recipeId){
      slotEl.innerHTML='';
      if(!recipeId){
        slotEl.innerHTML=`<div class="text-gray-400 text-center select-none"><i class="fa-solid fa-plus text-2xl mb-1"></i><div class="text-xs">Vac√≠o</div></div>`;
        return;
      }
      const r=recipes.find(x=>x.id===recipeId);
      const chip=document.createElement('div'); chip.className='meal-chip w-full justify-center';
      chip.draggable=true; chip.addEventListener('dragstart',e=> e.dataTransfer.setData('text/plain', String(recipeId)));
      chip.innerHTML=`
        <i class="fa-solid ${r && r.type==='lunch'?'fa-sun':'fa-moon'}"></i>
        <div class="meal-name" title="${r? r.name:'(eliminada)'}">${r? r.name:'Receta eliminada'}</div>
        <button class="ml-2 text-gray-500 hover:text-red-600" aria-label="Quitar"><i class="fa-solid fa-xmark"></i></button>`;
      chip.querySelector('button').addEventListener('click', ev=>{ ev.stopPropagation(); setSlot(slotEl.dataset.day, slotEl.dataset.meal, null); });
      slotEl.appendChild(chip);
    }
    function setSlot(dayKey,meal,recipeId){
      const plan=getActivePlan();
      plan.slots[`${dayKey}-${meal}`]=recipeId;
      storage.savePlan(plan.weekStartISO, plan);
      renderSlotContent(document.querySelector(`.meal-slot[data-day="${dayKey}"][data-meal="${meal}"]`), recipeId);
      sync.save(plan.weekStartISO, plan); // si alg√∫n d√≠a activas Firebase
    }
    function onSlotClick(e){
      const slot=e.currentTarget;
      if(selectedQuickRecipeId){ setSlot(slot.dataset.day, slot.dataset.meal, selectedQuickRecipeId); flash(slot); clearQuickSelection(); }
      else{ openRecipePicker(slot.dataset.day, slot.dataset.meal); }
    }
    function onSlotDrop(e){ e.preventDefault(); const id=Number(e.dataTransfer.getData('text/plain')); const s=e.currentTarget; setSlot(s.dataset.day, s.dataset.meal, id); flash(s); }
    function flash(el){ el.classList.add('ring','ring-emerald-300'); setTimeout(()=>el.classList.remove('ring','ring-emerald-300'),400); }

    /* Semana nav */
    function changeWeek(){ buildCalendarGrid(); sync.listen(toISO(currentWeekStart)); }
    $('#prev-week').addEventListener('click', ()=>{ currentWeekStart=addDays(currentWeekStart,-7); changeWeek(); });
    $('#next-week').addEventListener('click', ()=>{ currentWeekStart=addDays(currentWeekStart, 7); changeWeek(); });
    $('#clear-plan').addEventListener('click', ()=>{ if(confirm('¬øVaciar planificaci√≥n de esta semana?')){ storage.clearPlan(toISO(currentWeekStart)); buildCalendarGrid(); sync.save(toISO(currentWeekStart), emptyPlan()); }});

    /* Quick Add */
    function renderQuickAdd(){
      const cont=$('#quick-recipes'); cont.innerHTML='';
      const pool=[...recipes].sort(()=>Math.random()-0.5).slice(0,8);
      for(const r of pool){
        const b=document.createElement('button');
        b.className='border rounded-lg px-3 py-2 flex items-center gap-2';
        b.innerHTML=`<i class="fa-solid ${r.type==='lunch'?'fa-sun text-amber-500':'fa-moon text-blue-500'}"></i><span>${r.name}</span>`;
        b.addEventListener('click',()=>{ selectedQuickRecipeId=r.id; $$('#quick-recipes button').forEach(x=>{x.classList.remove('text-white'); x.style.background='';}); b.classList.add('text-white'); b.style.background='var(--brand)'; });
        cont.appendChild(b);
      }
    }
    function clearQuickSelection(){ selectedQuickRecipeId=null; $$('#quick-recipes button').forEach(x=>{x.classList.remove('text-white'); x.style.background='';}); }

    /* Grid de recetas */
    function renderRecipesGrid(){
      const grid=$('#recipes-grid'); grid.innerHTML='';
      const q=($('#recipe-search').value||'').trim().toLowerCase();
      const diff=$('#difficulty-filter').value; const type=$('#type-filter').value;
      const filtered=recipes.filter(r=>{
        const txt=[r.name,r.description,...r.ingredients].join(' ').toLowerCase();
        return (!q || txt.includes(q)) && (!diff || r.difficulty===diff) && (!type || r.type===type);
      });
      for(const r of filtered){
        const card=document.createElement('article'); card.className='bg-white rounded-xl shadow p-4 hover-lift'; card.draggable=true;
        card.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', String(r.id)));
        card.innerHTML=`
          <div class="flex items-start justify-between">
            <h3 class="font-semibold text-gray-900 pr-6">${r.name}</h3>
            <span class="text-xs px-2 py-1 rounded-full ${r.type==='lunch'?'bg-amber-100 text-amber-700':'bg-blue-100 text-blue-700'}">${r.type==='lunch'?'Comida':'Cena'}</span>
          </div>
          <p class="text-sm text-gray-600 mt-1">${r.description}</p>
          <div class="mt-3 flex items-center gap-3 text-xs text-gray-500">
            <span><i class="fa-regular fa-clock mr-1"></i>${r.time} min</span>
            <span class="capitalize"><i class="fa-solid fa-signal mr-1"></i>${r.difficulty}</span>
          </div>
          <div class="mt-3">
            <div class="text-xs text-gray-400">Ingredientes:</div>
            <div class="text-sm">${r.ingredients.slice(0,6).join(', ')}${r.ingredients.length>6?'‚Ä¶':''}</div>
          </div>
          <div class="mt-4 flex gap-2">
            <button class="px-3 py-2 rounded-lg border hover:bg-gray-50 add-to-slot">A√±adir a‚Ä¶</button>
            <button class="px-3 py-2 rounded-lg text-white quick-to-selected" style="background:var(--brand)">R√°pido</button>
            <button class="ml-auto px-3 py-2 rounded-lg border text-red-600 hover:bg-red-50 delete-recipe" title="Eliminar"><i class="fa-solid fa-trash"></i></button>
          </div>`;
        card.querySelector('.add-to-slot').addEventListener('click',()=> openRecipePicker(null,null,r.id));
        card.querySelector('.quick-to-selected').addEventListener('click',()=>{ selectedQuickRecipeId=r.id; tabs.show('calendar'); alert('Receta seleccionada. Toca una casilla del calendario.'); });
        card.querySelector('.delete-recipe').addEventListener('click',()=> deleteRecipe(r.id));
        grid.appendChild(card);
      }
      updateStats();
    }
    function deleteRecipe(id){ if(!confirm('¬øEliminar esta receta?')) return; recipes = recipes.filter(r=>r.id!==id); storage.saveRecipes(recipes); renderRecipesGrid(); renderQuickAdd(); updateStats(); }

    /* Modal picker */
    let modalTarget={day:null,meal:null};
    function openRecipePicker(day,meal,preselectId){ modalTarget={day,meal}; $('#recipe-modal').classList.remove('hidden'); renderModalList(preselectId||null); }
    function closeRecipePicker(){ $('#recipe-modal').classList.add('hidden'); $('#modal-search').value=''; }
    $('#close-modal').addEventListener('click', closeRecipePicker);
    $('#recipe-modal').addEventListener('click', e=>{ if(e.target.id==='recipe-modal') closeRecipePicker(); });

    function renderModalList(pre){
      const list=$('#modal-list'); list.innerHTML='';
      const q=($('#modal-search').value||'').trim().toLowerCase();
      const filtered=recipes.filter(r=> !q || [r.name,r.description,...r.ingredients].join(' ').toLowerCase().includes(q));
      for(const r of filtered){
        const row=document.createElement('div'); row.className='flex items-center gap-3 p-3 rounded-lg border hover:bg-gray-50';
        row.innerHTML=`<div class="flex-1 min-w-0"><div class="flex items-center gap-2"><span class="text-sm font-medium truncate">${r.name}</span>
          <span class="text-[10px] px-2 py-0.5 rounded-full ${r.type==='lunch'?'bg-amber-100 text-amber-700':'bg-blue-100 text-blue-700'}">${r.type==='lunch'?'Comida':'Cena'}</span>
          <span class="text-[10px] text-gray-500">¬∑ ${r.time} min ¬∑ ${r.difficulty}</span></div>
          <div class="text-xs text-gray-500 truncate">${r.ingredients.join(', ')}</div></div>
          <button class="px-3 py-1.5 rounded-lg text-white" style="background:var(--brand)">Seleccionar</button>`;
        row.querySelector('button').addEventListener('click',()=>{ const id=r.id; if(modalTarget.day&&modalTarget.meal){ setSlot(modalTarget.day, modalTarget.meal, id); } closeRecipePicker(); });
        if(pre && pre===r.id){ row.classList.add('ring','ring-emerald-200'); }
        list.appendChild(row);
      }
      $('#modal-search').oninput=()=> renderModalList(pre||null);
    }

    /* Modal a√±adir receta */
    $('#add-recipe-btn').addEventListener('click',()=> $('#add-recipe-modal').classList.remove('hidden'));
    $('#close-add-modal').addEventListener('click',()=> $('#add-recipe-modal').classList.add('hidden'));
    $('#cancel-add').addEventListener('click',()=> $('#add-recipe-modal').classList.add('hidden'));

    $('#add-recipe-form').addEventListener('submit', e=>{
      e.preventDefault();
      const name=$('#recipe-name').value.trim();
      const description=$('#recipe-description').value.trim();
      const type=$('#recipe-type').value; const difficulty=$('#recipe-difficulty').value;
      const time=Number($('#recipe-time').value);
      const ingredients=$('#recipe-ingredients').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      const id=(recipes.reduce((m,r)=>Math.max(m,r.id),0)||0)+1;
      recipes.push({id,name,description,type,difficulty,time,ingredients});
      storage.saveRecipes(recipes);
      e.target.reset(); $('#add-recipe-modal').classList.add('hidden');
      renderRecipesGrid(); renderQuickAdd(); updateStats();
    });

    /* Export / Import */
    $('#export-json').addEventListener('click', ()=>{
      const blob=new Blob([JSON.stringify({recipes},null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='meal-planner-recipes.json'; a.click();
    });
    $('#import-json').addEventListener('change', e=>{
      const file=e.target.files?.[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const data=JSON.parse(reader.result);
          recipes=Array.isArray(data)?data:(Array.isArray(data.recipes)?data.recipes:recipes);
          storage.saveRecipes(recipes); renderRecipesGrid(); renderQuickAdd(); updateStats();
          alert('Importado correctamente');
        }catch(err){ alert('Error al importar: '+err.message); }
        e.target.value='';
      };
      reader.readAsText(file);
    });

    /* Tabs */
    const tabs={ show(name){
      $$('.tab-content').forEach(s=>s.classList.add('hidden'));
      $('#'+name+'-view').classList.remove('hidden');
      $$('.tab-button').forEach(b=>{ b.classList.remove('tab-active'); b.classList.add('tab-inactive'); });
      $('#tab-'+name).classList.add('tab-active'); $('#tab-'+name).classList.remove('tab-inactive');
      if(name==='recipes') renderRecipesGrid();
    }};
    $('#tab-calendar').addEventListener('click', ()=>tabs.show('calendar'));
    $('#tab-recipes').addEventListener('click',  ()=>tabs.show('recipes'));
    $('#tab-shopping').addEventListener('click', ()=>tabs.show('shopping'));

    /* Lista de la compra */
    $('#generate-list-btn').addEventListener('click', generateShoppingList);
    $('#clear-list-btn').addEventListener('click',()=>{ $('#shopping-list').innerHTML=$('#shopping-empty').outerHTML; $('#top-ingredients').innerHTML=''; });
    function generateShoppingList(){
      const plan=getActivePlan(); const counts=new Map();
      Object.keys(plan.slots).forEach(k=>{
        const id=plan.slots[k]; if(!id) return; const r=recipes.find(x=>x.id===id); if(!r) return;
        r.ingredients.forEach(ing=> counts.set(ing,(counts.get(ing)||0)+1));
      });
      const list=$('#shopping-list'); list.innerHTML='';
      if(!counts.size){ list.innerHTML=$('#shopping-empty').outerHTML; return; }
      Array.from(counts.entries()).sort((a,b)=> a[0].localeCompare(b[0],'es')).forEach(([name,qty])=>{
        const row=document.createElement('div'); row.className='flex items-center justify-between p-2 border rounded-lg';
        row.innerHTML=`<span class="text-sm">${name}</span><span class="text-xs text-gray-500">${qty}</span>`; list.appendChild(row);
      });
      const top=Array.from(counts.entries()).sort((a,b)=> b[1]-a[1]).slice(0,8);
      const box=$('#top-ingredients'); box.innerHTML='';
      top.forEach(([name,qty])=>{
        const chip=document.createElement('div'); chip.className='inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-100 mr-2 mb-2';
        chip.innerHTML=`<i class="fa-solid fa-hashtag text-xs"></i><span class="text-sm">${name}</span><span class="text-xs text-gray-500">√ó${qty}</span>`;
        box.appendChild(chip);
      });
      tabs.show('shopping');
    }

    /* KPIs */
    function updateStats(){
      const lc=recipes.filter(r=>r.type==='lunch').length;
      const dc=recipes.filter(r=>r.type==='dinner').length;
      $('#kpi-total-recipes').textContent=String(recipes.length);
      $('#kpi-lunch-recipes').textContent=String(lc);
      $('#kpi-dinner-recipes').textContent=String(dc);
      $('#recipes-count').textContent=String(lc);
      $('#dinners-count').textContent=String(dc);
      const set=new Set(); recipes.forEach(r=>r.ingredients.forEach(i=>set.add(i))); $('#total-ingredients').textContent=String(set.size);
    }

    /* =========================
       Firebase Sync (opcional)
       ========================= */
    const ENABLE_SYNC=false; // lo dejamos desactivado de momento
    const GROUP_ID='familia-juan-marian';
    const firebaseConfig={apiKey:"PON_AQUI",authDomain:"PON_AQUI.firebaseapp.com",databaseURL:"https://PON_AQUI-default-rtdb.europe-west1.firebasedatabase.app",projectId:"PON_AQUI",storageBucket:"PON_AQUI.appspot.com",messagingSenderId:"PON_AQUI",appId:"PON_AQUI"};
    const sync=(function(){
      let app=null, db=null, ref=null;
      function init(){ try{ if(!ENABLE_SYNC) return; app=firebase.initializeApp(firebaseConfig); db=firebase.database(); }catch(e){ console.warn('Firebase no activo:', e.message); app=null; db=null; } }
      function path(weekISO){ return 'plans/'+GROUP_ID+'/'+weekISO; }
      function save(weekISO, plan){ if(!db) return; try{ db.ref(path(weekISO)).set(plan); }catch(e){ console.warn('Sync error:', e.message); } }
      function listen(weekISO){
        if(!db) return;
        if(ref) ref.off();
        ref=db.ref(path(weekISO));
        ref.on('value', snap=>{
          const cloud=snap.val(); if(!cloud) return;
          const local=storage.getPlan(weekISO);
          if(JSON.stringify(local)!==JSON.stringify(cloud)){
            storage.savePlan(weekISO, cloud);
            if(weekISO===toISO(currentWeekStart)) buildCalendarGrid();
          }
        });
      }
      return {init,save,listen};
    })();

    /* Init */
    function init(){
      buildCalendarGrid();
      renderQuickAdd();
      updateStats();
      // filtros
      $('#recipe-search').addEventListener('input', renderRecipesGrid);
      $('#difficulty-filter').addEventListener('change', renderRecipesGrid);
      $('#type-filter').addEventListener('change', renderRecipesGrid);
      // sync
      sync.init(); sync.listen(toISO(currentWeekStart));
    }
    init();
  </script>
</body>
</html>
